import{P as i,t as fe,r as t,v as q,j as e,S as h,p as V,T as z,M as E,l as N,w as Y,x as G,y as J,z as O,A as me}from"./index-XujsHqft.js";import{A as he,d as pe,a as xe,W as Se,R as Re,V as ye,L as je}from"./VideoAudioSelect-Dp8L_DPw.js";import{d as ve,I as Q}from"./DeleteOutline-C8hWQd_u.js";X.propTypes={username:i.string.isRequired,material:i.string,speed:i.string,isCamera:i.bool.isRequired,measurementCounter:i.number.isRequired,setMeasurementCounter:i.func.isRequired,isRecordingStarted:i.func.isRequired,selectedVideoDevices:i.array.isRequired,videoDevices:i.array.isRequired,audioFiles:i.array.isRequired,setAudioFiles:i.func.isRequired,setRecordingStatus:i.string.isRequired,localDir:i.string.isRequired};function X({username:u,material:n,speed:d,measurementCounter:g,setMeasurementCounter:R,selectedVideoDevices:v,videoDevices:w,setAudioFiles:b,setRecordingStatus:M,localDir:C}){const c=fe(),$=t.useRef(null),f=t.useRef([]),[B,K]=t.useState([]),[p,x]=t.useState([]),[U,_]=t.useState([]),[y,a]=t.useState(!1),[j,Z]=t.useState(!1),[A,I]=t.useState(!1),[ee,m]=t.useState(""),W=t.useCallback((s,{data:r},o)=>{r.size>0&&x(S=>[...S,{recorder:s,data:r,cameraIndex:o}])},[x]),se=async()=>{try{const r=(await Promise.all(U.map(async o=>{const S=w[o];if(!S)return console.log("Video device not found. Camera Index: "+o),null;const D=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:S.deviceId}},audio:!0}),l=new Re(D,{mimeType:"video/webm"});return l.startRecording(),l.ondataavailable=P=>W(l,{data:P},o),f.current.push({recorder:l,stream:D}),{recorder:l,stream:D}}))).filter(Boolean);f.current=r}catch(s){console.error("Error starting multiple recordings:",s),m(`Error starting recordings: ${s.message}`)}},te=()=>{f.current&&f.current.length>0?(f.current.forEach(({recorder:s,stream:r})=>{s.stopRecording(()=>{const o=s.getBlob();W(s,{data:o})}),r.getTracks().forEach(o=>o.stop())}),f.current=[]):console.warn("No recordings to stop or recorders were not initialized.")};t.useEffect(()=>{j?se():te()},[j]);const H=async()=>{if(p&&p.length>0){I(!1);let s=0;const r=p.map(async({data:o,cameraIndex:S})=>{const D=new Blob([o],{type:"video/webm"}),l=new Date,P=l.getFullYear(),ae=String(l.getMonth()+1).padStart(2,"0"),re=String(l.getDate()).padStart(2,"0"),oe=String(l.getHours()).padStart(2,"0"),ne=String(l.getMinutes()).padStart(2,"0"),ie=String(l.getSeconds()).padStart(2,"0"),de=`${P}${ae}${re}_${oe}${ne}${ie}`,ce=`${u}_${n}_${d}_camera${S||s}_${de}.webm`;S===void 0&&s++;const T=new FileReader;return new Promise((le,ue)=>{T.onloadend=async()=>{const ge=T.result.split(",")[1];try{const k=await q.post("/save_video",{filename:ce,local_dir:C,data:ge});le(k.data)}catch(k){console.error("Error uploading video:",k),ue(k)}},T.readAsDataURL(D)})});try{const o=await Promise.all(r);console.log("Uploaded videos:",o),m(c.formatMessage({id:"recordingUploaded"})+o[0].filename)}catch(o){console.error("Error during upload:",o)}}else console.log("Error with recorded chunks")},L=t.useCallback(async()=>{a(!0);try{if(j){const s=await q.get("/stop"),r=s.data.map(o=>o.filename);m(c.formatMessage({id:"recordedSuccesfully"})+r.join(", ")),R(g+1),I(!0),b(s.data),M("stop")}else m(c.formatMessage({id:"connectingToRaspberry"})),await q.post("/start",{username:u,material:n,speed:d}),m(c.formatMessage({id:"recordingStarted"})),A&&await H(),I(!1),_(v.map(s=>w.findIndex(r=>r.label===s)).filter(s=>s!==-1)),x([]),M("start");Z(s=>!s)}catch(s){m(c.formatMessage({id:"recordingConnectFailed"})+s)}finally{a(!1)}},[j,g,u,n,d,R,b]),F=t.useCallback(async()=>{a(!0);try{const s=await q.get("/delete_last");m(c.formatMessage({id:"recordingDeleteSuccess"})+s.data),R(g-1>=0?g-1:0),I(!1),x([]),M("delete")}catch(s){m(c.formatMessage({id:"recordingDeleteFailed"})+s)}finally{a(!1)}},[g,R]);return t.useEffect(()=>{const s=r=>{y||d==null||n==null||d==null||n==null||(r.ctrlKey&&r.shiftKey&&r.key==="R"?L():r.ctrlKey&&r.shiftKey&&r.key==="D"&&F())};return window.addEventListener("keydown",s),()=>{window.removeEventListener("keydown",s)}},[L,F]),e.jsxs(h,{spacing:2,children:[e.jsx(he,{}),e.jsxs(h,{direction:"row",spacing:2,children:[e.jsx(V,{onClick:L,variant:"contained",startIcon:j?e.jsx(pe,{sx:{color:"red"}}):null,disabled:y||d==null||n==null||d==null||n==null,children:j?c.formatMessage({id:"stopRecording"}):c.formatMessage({id:"startRecording"})}),A&&e.jsx(V,{onClick:F,variant:"contained",disabled:y||d==null||n==null||d==null||n==null,startIcon:e.jsx(ve,{}),children:c.formatMessage({id:"deleteRecording"})}),A&&p&&p.length>0&&e.jsx(V,{onClick:H,variant:"contained",ref:B,disabled:y||d==null||n==null||d==null||n==null,startIcon:e.jsx(xe,{}),children:c.formatMessage({id:"downloadRecording"})})]}),e.jsx(z,{children:ee}),e.jsx(Se,{selectedVideoDevices:v,videoDevices:w,webcamRef:$})]})}const we=({config:u})=>{const[n,d]=t.useState([]),[g,R]=t.useState([]),[v,w]=t.useState(null),[b,M]=t.useState(null),[C,c]=t.useState(0),[$,f]=t.useState([]),[B,K]=t.useState("init"),p=sessionStorage.getItem("commentAcquisiton")||"",[x,U]=t.useState(p),_=a=>{w(a.target.value)},y=a=>{M(a.target.value)};return t.useEffect(()=>{sessionStorage.setItem("commentAcquisiton",x)},[x]),console.log("Acq",u),e.jsx("div",{children:e.jsxs(h,{sx:{width:"100%",gap:10},direction:"row",children:[e.jsxs(h,{sx:{gap:3,width:"35%"},children:[e.jsxs(z,{id:"username",labelId:"usernameLabel",variant:"h6",children:[e.jsx(E,{id:"username"}),": ",u.username]}),e.jsxs(h,{sx:{width:"100%",gap:2},children:[e.jsx(ye,{selectedVideoDevices:n,setSelectedVideoDevices:d,videoDevices:g,setVideoDevices:R}),e.jsxs(h,{sx:{width:"100%",gap:2},children:[e.jsxs(N,{sx:Y,children:[e.jsx(Q,{children:e.jsx(E,{id:"Material"})}),e.jsx(G,{sx:J,labelId:"materialSelect",label:"Material",id:"material",value:v,onChange:_,children:u.chosenMaterials.filter(a=>a!==0).map(a=>e.jsx(O,{value:a,children:a},a))})]}),e.jsxs(N,{sx:Y,children:[e.jsx(Q,{children:e.jsx(E,{id:"speed"})}),e.jsx(G,{sx:J,labelId:"materialSelect",label:"Speed",id:"speed",value:b,onChange:y,children:u.chosenSpeeds.filter(a=>a!==0).map(a=>e.jsx(O,{value:a,children:a},a))})]})]})]}),e.jsx(h,{sx:{width:"100%"},children:e.jsx(je,{config:u})}),e.jsxs(z,{children:[e.jsx(E,{id:"performedMeasurements"}),": ",C]})]}),e.jsx(h,{sx:me,mt:1,spacing:2,children:e.jsx(X,{username:u.username,material:v,speed:b,measurementCounter:C,setMeasurementCounter:c,selectedVideoDevices:n,videoDevices:g,audioFiles:$,setAudioFiles:f,setRecordingStatus:K,localDir:u.local_dir})})]})})};we.propTypes={config:i.object.isRequired};export{we as default};
